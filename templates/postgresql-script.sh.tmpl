#!/bin/bash
{% if postgresql.host is defined %}

{{directory}}/script/postgresql-event-generator

createdb -U postgres -h {{ postgresql.host.name }} -p {{postgresql.port}} {{table}}
psql -d {{table}} -U postgres -h {{ postgresql.host.name }} -p {{postgresql.port}} -f {{directory}}/YCSB/jdbc/src/main/resources/sql/create_table.sql

mkdir -p {{ directory }}/results/postgresql
rm -f -r {{ directory }}/results/postgresql/*  

touch {{ directory }}/results/postgresql/timings.out

echo "Start $(date)" >>  {{ directory }}/results/postgresql/timings.out        
{{ directory }}/script/postgresql-delete

{{directory}}/YCSB/bin/ycsb load jdbc -P {{directory}}/config/postgresql.conf -P {{directory}}/config/workload-ycsb-thomas -P {{directory}}/config/workload-ycsb-thomas-load -s	> {{ directory }}/results/postgresql/load-unlimited.dat;
sleep 50s
{{directory}}/YCSB/bin/ycsb run jdbc -P {{directory}}/config/postgresql.conf -P {{directory}}/config/workload-ycsb-thomas -P {{directory}}/config/workload-ycsb-thomas-stress-load -s -threads 30  > {{ directory }}/results/postgresql/unlimited.dat	
sleep 20s

for t in 20 50 100 150 200 250 300 400 500 600 700; do
	for i in 2;do
	echo "Hockey $t $i $(date)" >>  {{ directory }}/results/postgresql/timings.out        
	
	{{ directory }}/script/postgresql-delete
	{{directory}}/YCSB/bin/ycsb load jdbc -P {{directory}}/config/postgresql.conf -P {{directory}}/config/workload-ycsb-thomas -P {{directory}}/config/workload-ycsb-thomas-load -s	 > {{ directory }}/results/postgresql/load-threads-$t-$i.dat;
	sleep 50s
	{{directory}}/YCSB/bin/ycsb run jdbc -P {{directory}}/config/postgresql.conf -P {{directory}}/config/workload-ycsb-thomas -P {{directory}}/config/workload-ycsb-thomas-stress-load -s -threads 30 -target $t  > {{ directory }}/results/postgresql/threads-$t-$i.dat;
	
	done;
done;     

sleep 100s
{%for node in postgresql.pgpoolNodes %}
           
 	#postgresql - Continuous run: 900s!
	for run in 1 2 ;do
		echo "Continiuum {{node.host.name}} $run $(date)" >>  {{ directory }}/results/postgresql/timings.out        
	
		{{ directory }}/script/postgresql-delete;
		
		{{directory}}/YCSB/bin/ycsb load jdbc -P {{directory}}/config/postgresql.conf -P {{directory}}/config/workload-ycsb-thomas -P {{directory}}/config/workload-ycsb-thomas-load -s	> {{directory}}/results/postgresql/load-continuous-{{ node.host.name }}-$run.dat;
		sleep 50s
		{{directory}}/YCSB/bin/ycsb run jdbc -P {{directory}}/config/postgresql.conf -P {{directory}}/config/workload-ycsb-thomas -P {{directory}}/config/workload-ycsb-thomas-continuous -s -target 20 -p eventFile={{directory}}/config/postgresql/postgresql-event-{{ node.host.name }}.xml > {{directory}}/results/postgresql/continuous-{{ node.host.name }}-$run.dat;
		sleep 50s;
		{{ directory }}/script/postgresql-remote-recover {{ loop.index0}} {{ node.host.name }};
	done;
{% endfor %}


{%for node in postgresql.pgpoolNodes %}
           
 	#postgresql - Continuous run: 900s!
	for run in 1 2 ;do
		echo "Continiuum {{node.host.name}} $run $(date)" >>  {{ directory }}/results/postgresql/timings.out        
	
		{{ directory }}/script/postgresql-delete;
		
		{{directory}}/YCSB/bin/ycsb load jdbc -P {{directory}}/config/postgresql.conf -P {{directory}}/config/workload-ycsb-thomas -P {{directory}}/config/workload-ycsb-thomas-load -s	{{directory}}/results/postgresql/load-continuous-{{ node.host.name }}-kill-$run.dat;
		sleep 50s
		{{directory}}/YCSB/bin/ycsb run jdbc -P {{directory}}/config/postgresql.conf -P {{directory}}/config/workload-ycsb-thomas -P {{directory}}/config/workload-ycsb-thomas-continuous -s -target 20 -p eventFile={{directory}}/config/postgresql/postgresql-event-{{ node.host.name }}-kill.xml > {{directory}}/results/postgresql/continuous-{{ node.host.name }}-kill-$run.dat;
		sleep 50s;
		{{ directory }}/script/postgresql-remote-recover {{ loop.index0}} {{ node.host.name }};
	done;
{% endfor %}
{% endif %}